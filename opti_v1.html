<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Bus Route Optimization System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            height: fit-content;
        }
        
        .map-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .section {
            margin-bottom: 25px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 20px;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section h3 {
            color: #2d3748;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-input {
            margin-bottom: 15px;
        }
        
        .file-input label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 600;
        }
        
        .file-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .file-input input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .api-key-input {
            margin-bottom: 15px;
        }
        
        .api-key-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .api-key-input input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .status.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        
        .status.info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .metric-card h4 {
            color: #2d3748;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .metric-card .value {
            color: #4299e1;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .routes-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .route-item {
            background: #f7fafc;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .route-item h5 {
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .route-item p {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .route-selector-controls {
            margin-top: 15px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px;
        }

        .route-selector-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .route-selector-item:hover {
            background-color: #f7fafc;
        }

        .route-selector-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
        }

        .individual-routes {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        .route-selector-item span {
            font-size: 14px;
            color: #4a5568;
        }

        .route-selector-item.selected {
            background-color: #ebf8ff;
            border-color: #90cdf4;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.1);
        }

        .route-selector-item:first-child {
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 10px;
            padding-bottom: 15px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-bus"></i> College Bus Route Optimization System</h1>
            <p>Optimize bus routes for maximum efficiency, covering maximum stops with minimal distance on major roads. Built for Chennai and nearby regions with Google Route Optimization API.</p>
        </div>
        
        <div class="main-content">
            <div class="control-panel">
                <div class="section">
                    <h3><i class="fas fa-upload"></i> Data Input</h3>
                    
                    <div class="file-input">
                        <label for="studentFile">Student Assignments CSV:</label>
                        <input type="file" id="studentFile" accept=".csv" />
                    </div>
                    
                    <div class="file-input">
                        <label for="stopsFile">Snapped Stops CSV:</label>
                        <input type="file" id="stopsFile" accept=".csv" />
                    </div>
                    
                    <div class="file-input">
                        <label for="depotsFile">Depots CSV:</label>
                        <input type="file" id="depotsFile" accept=".csv" />
                    </div>
                    
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-database"></i> Load Data
                    </button>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-cogs"></i> Configuration</h3>
                    
                    <div class="file-input">
                        <label for="maxCapacity">Bus Capacity:</label>
                        <input type="number" id="maxCapacity" value="55" min="1" max="100" />
                    </div>
                    
                    <div class="file-input">
                        <label for="shiftTime">Shift Time:</label>
                        <select id="shiftTime">
                            <option value="8am">8:00 AM</option>
                            <option value="10am">10:00 AM</option>
                            <option value="3pm">3:00 PM</option>
                            <option value="5pm">5:00 PM</option>
                        </select>
                    </div>
                    
                    <div class="file-input">
                        <label for="dayOfWeek">Day of Week:</label>
                        <select id="dayOfWeek">
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                            <option value="saturday">Saturday</option>
                        </select>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-route"></i> Optimization</h3>
                    
                    <button class="btn btn-success" onclick="optimizeRoutes()" id="optimizeBtn" disabled>
                        <i class="fas fa-magic"></i> Optimize Routes
                    </button>
                    
                    <button class="btn btn-info" onclick="visualizeData()">
                        <i class="fas fa-map"></i> Show Current Data
                    </button>
                    
                    <button class="btn btn-warning" onclick="exportResults()" id="exportBtn" disabled>
                        <i class="fas fa-download"></i> Export Results
                    </button>
                </div>

                <div class="section" id="routeSelectorSection" style="display: none;">
                    <h3><i class="fas fa-filter"></i> Route Selector</h3>
                    <div class="route-selector-controls">
                        <label class="route-selector-item">
                            <input type="radio" name="routeSelection" id="selectAllRoutes" checked onchange="toggleAllRoutes()">
                            <span>Show All Routes</span>
                        </label>
                        <div id="individualRouteSelectors" class="individual-routes">
                            <!-- Individual route radio buttons will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <div id="status" class="status"></div>
                
                <div id="metrics" class="metrics" style="display: none;">
                    <div class="metric-card">
                        <h4>Total Students</h4>
                        <div class="value" id="totalStudents">0</div>
                    </div>
                    <div class="metric-card">
                        <h4>Required Buses</h4>
                        <div class="value" id="requiredBuses">0</div>
                    </div>
                    <div class="metric-card">
                        <h4>Total Stops</h4>
                        <div class="value" id="totalStops">0</div>
                    </div>
                    <div class="metric-card">
                        <h4>Available Depots</h4>
                        <div class="value" id="totalDepots">0</div>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <h3><i class="fas fa-map-marked-alt"></i> Route Visualization</h3>
                <div id="map"></div>
            </div>
        </div>
        
        <div class="results-panel" id="resultsPanel" style="display: none;">
            <h3><i class="fas fa-chart-line"></i> Optimization Results</h3>
            <div id="routesList" class="routes-list"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        // Global variables for data storage
        let studentData = [];
        let stopsData = [];
        let depotsData = [];
        let map = null;
        let optimizationResults = [];
        
        // API Configuration
        const GOOGLE_API_KEY = 'AIzaSyAiVn2TbI7qSuTzw1EKvY4urq7V5aTZkZg'; // Replace with your actual Google API key
        
        // College coordinates
        const COLLEGE_COORDS = [13.008867898985972, 80.00353386796435];
        
        // Route colors for visualization
        const ROUTE_COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];
        
        // Initialize map
        function initMap() {
            if (map) return;
            
            map = L.map('map').setView(COLLEGE_COORDS, 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add college marker
            L.marker(COLLEGE_COORDS, {
                icon: L.divIcon({
                    html: '<i class="fas fa-university" style="color: #2d3748; font-size: 20px;"></i>',
                    iconSize: [30, 30],
                    className: 'college-icon'
                })
            }).addTo(map).bindPopup('<b>Rajalakshmi Engineering College</b><br>Starting Point');
        }
        
        // Show status message
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            status.style.display = 'flex';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
        
        // Parse CSV data
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        if (results.errors.length > 0) {
                            reject(results.errors);
                        } else {
                            resolve(results.data);
                        }
                    },
                    error: reject
                });
            });
        }
        
        // Load and process data
        async function loadData() {
            try {
                const studentFile = document.getElementById('studentFile').files[0];
                const stopsFile = document.getElementById('stopsFile').files[0];
                const depotsFile = document.getElementById('depotsFile').files[0];
                const apiKey = GOOGLE_API_KEY;
                
                if (!studentFile || !stopsFile || !depotsFile) {
                    showStatus('Please select all required CSV files', 'error');
                    return;
                }
                
                // API key is now hardcoded in the code
                
                showStatus('Loading and processing data...', 'info');
                
                // Parse CSV files
                studentData = await parseCSV(studentFile);
                stopsData = await parseCSV(stopsFile);
                depotsData = await parseCSV(depotsFile);
                
                // Validate and process data
                validateData();
                updateMetrics();
                
                document.getElementById('optimizeBtn').disabled = false;
                showStatus('Data loaded successfully! Ready for optimization.', 'success');
                
                // Initialize map if not already done
                initMap();
                visualizeData();
                
            } catch (error) {
                showStatus(`Error loading data: ${error.message || error}`, 'error');
                console.error('Data loading error:', error);
            }
        }
        
        // Validate loaded data
        function validateData() {
            // Validate student data
            if (!studentData.length || !studentData[0].student_lat) {
                throw new Error('Invalid student assignments data format');
            }
            
            // Validate stops data
            if (!stopsData.length || !stopsData[0].snapped_lat) {
                throw new Error('Invalid snapped stops data format');
            }
            
            // Validate depots data
            if (!depotsData.length || !depotsData[0].Latitude) {
                throw new Error('Invalid depots data format');
            }
            
            console.log(`Loaded ${studentData.length} students, ${stopsData.length} stops, ${depotsData.length} depots`);
        }
        
        // Update metrics display
        function updateMetrics() {
            const totalStudents = studentData.length;
            const requiredBuses = Math.ceil(totalStudents / parseInt(document.getElementById('maxCapacity').value));
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('requiredBuses').textContent = requiredBuses;
            document.getElementById('totalStops').textContent = stopsData.length;
            document.getElementById('totalDepots').textContent = depotsData.length;
            
            document.getElementById('metrics').style.display = 'grid';
        }
        
        // Visualize current data on map
        function visualizeData() {
            if (!map || !stopsData.length || !depotsData.length) {
                showStatus('Please load data first', 'error');
                return;
            }
            
            // Clear existing markers except college
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && layer.options.title !== 'college') {
                    map.removeLayer(layer);
                }
            });
            
            // Add bus stop markers
            stopsData.forEach((stop, index) => {
                const lat = parseFloat(stop.snapped_lat);
                const lon = parseFloat(stop.snapped_lon);
                const students = parseInt(stop.num_students);
                
                L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: `<div style="background: #4299e1; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${students}</div>`,
                        iconSize: [30, 30],
                        className: 'stop-icon'
                    })
                }).addTo(map)
                  .bindPopup(`<b>Stop ${stop.cluster_number}</b><br>
                             Students: ${students}<br>
                             Route: ${stop.route_name || 'Unknown'}<br>
                             Type: ${stop.route_type || 'Unknown'}`);
            });
            
            // Add depot markers
            depotsData.forEach((depot, index) => {
                const lat = parseFloat(depot.Latitude);
                const lon = parseFloat(depot.Longitude);
                const capacity = parseInt(depot.Counts);
                
                L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: `<i class="fas fa-warehouse" style="color: #e53e3e; font-size: 20px;"></i>`,
                        iconSize: [30, 30],
                        className: 'depot-icon'
                    })
                }).addTo(map)
                  .bindPopup(`<b>${depot['Parking Name']}</b><br>
                             Capacity: ${capacity} buses<br>
                             Coordinates: ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
            });
            
            // Fit map to show all markers
            const group = new L.featureGroup();
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    group.addLayer(layer);
                }
            });
            
            if (group.getLayers().length > 0) {
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Google Route Optimization API integration
        async function callGoogleRouteOptimization(requestData) {
            const apiKey = AIzaSyAiVn2TbI7qSuTzw1EKvY4urq7V5aTZkZg;
            const url = `https://routeoptimization.googleapis.com/v1/projects/YOUR_PROJECT_ID:optimizeRoutes?key=${apiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorData}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Google API Error:', error);
                throw error;
            }
        }
        
        // Prepare optimization request for Google API
        function prepareOptimizationRequest() {
            const maxCapacity = parseInt(document.getElementById('maxCapacity').value);
            const requiredBuses = Math.ceil(studentData.length / maxCapacity);
            
            // Prepare shipments (bus stops with student pickup)
            const shipments = stopsData.map((stop, index) => ({
                deliveries: [{
                    arrivalLocation: {
                        latLng: {
                            latitude: parseFloat(stop.snapped_lat),
                            longitude: parseFloat(stop.snapped_lon)
                        }
                    },
                    duration: "300s", // 5 minutes stop time
                    loadDemands: {
                        students: parseInt(stop.num_students)
                    }
                }],
                label: `stop_${stop.cluster_number}`
            }));
            
            // Prepare vehicles (buses)
            const vehicles = [];
            for (let i = 0; i < requiredBuses; i++) {
                vehicles.push({
                    startLocation: {
                        latLng: {
                            latitude: COLLEGE_COORDS[0],
                            longitude: COLLEGE_COORDS[1]
                        }
                    },
                    endLocation: {
                        latLng: {
                            latitude: parseFloat(depotsData[i % depotsData.length].Latitude),
                            longitude: parseFloat(depotsData[i % depotsData.length].Longitude)
                        }
                    },
                    loadLimits: {
                        students: {
                            maxLoad: maxCapacity
                        }
                    },
                    label: `bus_${i + 1}`,
                    routeModifiers: {
                        avoidTolls: false,
                        avoidHighways: false, // We want highways for efficiency
                        avoidFerries: true
                    }
                });
            }
            
            return {
                model: {
                    shipments: shipments,
                    vehicles: vehicles,
                    globalStartTime: "2024-01-01T08:00:00Z",
                    globalEndTime: "2024-01-01T20:00:00Z"
                },
                searchMode: "RETURN_FAST", // For quick results
                interpretInjectedSolutionsUsingLabels: false
            };
        }
        
        // Simulate optimization (for demo purposes, replace with actual API call)
        async function simulateOptimization() {
            const maxCapacity = parseInt(document.getElementById('maxCapacity').value);
            const routes = [];
            
            // Simple greedy algorithm for demonstration
            let currentRoute = [];
            let currentLoad = 0;
            let routeIndex = 0;
            
            // Sort stops by distance from college (simplified)
            const sortedStops = [...stopsData].sort((a, b) => {
                const distA = Math.sqrt(Math.pow(parseFloat(a.snapped_lat) - COLLEGE_COORDS[0], 2) + 
                                      Math.pow(parseFloat(a.snapped_lon) - COLLEGE_COORDS[1], 2));
                const distB = Math.sqrt(Math.pow(parseFloat(b.snapped_lat) - COLLEGE_COORDS[0], 2) + 
                                      Math.pow(parseFloat(b.snapped_lon) - COLLEGE_COORDS[1], 2));
                return distA - distB;
            });
            
            for (const stop of sortedStops) {
                const stopLoad = parseInt(stop.num_students);
                
                if (currentLoad + stopLoad <= maxCapacity) {
                    currentRoute.push(stop);
                    currentLoad += stopLoad;
                } else {
                    // Finalize current route
                    if (currentRoute.length > 0) {
                        routes.push({
                            busId: `Bus ${routeIndex + 1}`,
                            depot: depotsData[routeIndex % depotsData.length]['Parking Name'],
                            stops: [...currentRoute],
                            totalStudents: currentLoad,
                            efficiency: `${((currentLoad / maxCapacity) * 100).toFixed(1)}%`
                        });
                        routeIndex++;
                    }
                    
                    // Start new route
                    currentRoute = [stop];
                    currentLoad = stopLoad;
                }
            }
            
            // Add the last route
            if (currentRoute.length > 0) {
                routes.push({
                    busId: `Bus ${routeIndex + 1}`,
                    depot: depotsData[routeIndex % depotsData.length]['Parking Name'],
                    stops: currentRoute,
                    totalStudents: currentLoad,
                    efficiency: `${((currentLoad / maxCapacity) * 100).toFixed(1)}%`
                });
            }
            
            return routes;
        }
        
        // Main optimization function
        async function optimizeRoutes() {
            try {
                if (!studentData.length || !stopsData.length || !depotsData.length) {
                    showStatus('Please load data first', 'error');
                    return;
                }
                
                showStatus('Optimizing routes... This may take a moment.', 'info');
                document.getElementById('optimizeBtn').innerHTML = '<div class="loading"></div> Optimizing...';
                document.getElementById('optimizeBtn').disabled = true;
                
                // For demo purposes, using simulation. Replace with actual Google API call:
                // const requestData = prepareOptimizationRequest();
                // const results = await callGoogleRouteOptimization(requestData);
                
                optimizationResults = await simulateOptimization();
                
                visualizeOptimizedRoutes();
                displayResults();
                initializeRouteSelectors();
                
                document.getElementById('exportBtn').disabled = false;
                showStatus(`Route optimization completed! Generated ${optimizationResults.length} efficient routes.`, 'success');
                
            } catch (error) {
                showStatus(`Optimization failed: ${error.message}`, 'error');
                console.error('Optimization error:', error);
            } finally {
                document.getElementById('optimizeBtn').innerHTML = '<i class="fas fa-magic"></i> Optimize Routes';
                document.getElementById('optimizeBtn').disabled = false;
            }
        }
        
        // Visualize optimized routes on map with actual road tracing
        async function visualizeOptimizedRoutes() {
            if (!map || !optimizationResults.length) return;
            
            // Clear existing route layers
            map.eachLayer((layer) => {
                if (layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });
            
            showStatus('Tracing routes on actual roads...', 'info');
            
            // Draw routes with actual road tracing
            for (let index = 0; index < optimizationResults.length; index++) {
                const route = optimizationResults[index];
                const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                
                try {
                    // Create waypoints for the route
                    const waypoints = [];
                    
                    // Start from college
                    waypoints.push(COLLEGE_COORDS);
                    
                    // Add all stops in the route
                    route.stops.forEach(stop => {
                        waypoints.push([parseFloat(stop.snapped_lat), parseFloat(stop.snapped_lon)]);
                    });
                    
                    // End at depot
                    const depot = depotsData.find(d => d['Parking Name'] === route.depot);
                    if (depot) {
                        waypoints.push([parseFloat(depot.Latitude), parseFloat(depot.Longitude)]);
                    }
                    
                    // Get actual route from routing service
                    const actualRoute = await getActualRoute(waypoints);
                    
                    if (actualRoute && actualRoute.length > 0) {
                        // Create polyline for the actual route
                        const polyline = L.polyline(actualRoute, {
                            color: color,
                            weight: 5,
                            opacity: 0.8,
                            smoothFactor: 1,
                            className: `route-${index}`
                        }).addTo(map);
                        
                        // Calculate route metrics
                        const distance = calculateRouteDistance(actualRoute);
                        const estimatedTime = Math.round(distance * 2.5); // ~2.5 min per km in city traffic
                        
                        polyline.bindPopup(`<b>${route.busId}</b><br>
                                           Depot: ${route.depot}<br>
                                           Students: ${route.totalStudents}/55<br>
                                           Efficiency: ${route.efficiency}<br>
                                           Stops: ${route.stops.length}<br>
                                           Distance: ${distance.toFixed(1)} km<br>
                                           Est. Time: ${estimatedTime} min<br>
                                           <small>Route follows major roads & highways</small>`);
                        
                        // Add route markers for waypoints
                        waypoints.forEach((waypoint, wpIndex) => {
                            let markerHtml, popupContent;
                            
                            if (wpIndex === 0) {
                                // College marker
                                markerHtml = '<i class="fas fa-university" style="color: #2d3748; font-size: 16px;"></i>';
                                popupContent = `<b>Start: College</b><br>${route.busId}`;
                            } else if (wpIndex === waypoints.length - 1) {
                                // Depot marker
                                markerHtml = `<i class="fas fa-warehouse" style="color: ${color}; font-size: 16px;"></i>`;
                                popupContent = `<b>End: ${route.depot}</b><br>${route.busId}`;
                            } else {
                                // Stop marker
                                const stop = route.stops[wpIndex - 1];
                                markerHtml = `<div style="background: ${color}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${stop.num_students}</div>`;
                                popupContent = `<b>Stop ${stop.cluster_number}</b><br>
                                               Students: ${stop.num_students}<br>
                                               Road: ${stop.route_name || 'Unknown'}<br>
                                               ${route.busId}`;
                            }
                            
                            L.marker(waypoint, {
                                icon: L.divIcon({
                                    html: markerHtml,
                                    iconSize: [24, 24],
                                    className: `waypoint-icon route-${index}-marker`
                                }),
                                zIndexOffset: 1000
                            }).addTo(map).bindPopup(popupContent);
                        });
                        
                        // Update route object with actual metrics
                        route.actualDistance = distance;
                        route.estimatedTime = estimatedTime;
                    }
                    
                } catch (error) {
                    console.error(`Error tracing route ${index + 1}:`, error);
                    // Fallback to straight lines if routing fails
                    const fallbackCoords = [];
                    fallbackCoords.push(COLLEGE_COORDS);
                    route.stops.forEach(stop => {
                        fallbackCoords.push([parseFloat(stop.snapped_lat), parseFloat(stop.snapped_lon)]);
                    });
                    
                    const depot = depotsData.find(d => d['Parking Name'] === route.depot);
                    if (depot) {
                        fallbackCoords.push([parseFloat(depot.Latitude), parseFloat(depot.Longitude)]);
                    }
                    
                    L.polyline(fallbackCoords, {
                        color: color,
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '10, 5'
                    }).addTo(map).bindPopup(`<b>${route.busId}</b><br>
                                            Depot: ${route.depot}<br>
                                            Students: ${route.totalStudents}<br>
                                            Efficiency: ${route.efficiency}<br>
                                            <small>Approximate route (routing failed)</small>`);
                }
            }
            
            showStatus('Route tracing completed!', 'success');
        }
        
        // Get actual route using OSRM (Open Source Routing Machine) - free alternative
        async function getActualRoute(waypoints) {
            try {
                if (waypoints.length < 2) return null;
                
                // Build OSRM API request for driving directions
                const coordinates = waypoints.map(wp => `${wp[1]},${wp[0]}`).join(';');
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson&steps=true`;
                
                const response = await fetch(osrmUrl);
                
                if (!response.ok) {
                    throw new Error(`OSRM API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.routes && data.routes[0] && data.routes[0].geometry) {
                    // Convert GeoJSON coordinates to Leaflet format [lat, lng]
                    return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                }
                
                return null;
                
            } catch (error) {
                console.error('OSRM routing error:', error);
                
                // Fallback to Google Directions API if available
                return await getGoogleDirectionsRoute(waypoints);
            }
        }
        
        // Google Directions API fallback (requires API key)
        async function getGoogleDirectionsRoute(waypoints) {
            try {
                const apiKey = GOOGLE_API_KEY;
                
                const origin = `${waypoints[0][0]},${waypoints[0][1]}`;
                const destination = `${waypoints[waypoints.length - 1][0]},${waypoints[waypoints.length - 1][1]}`;
                
                let waypointsParam = '';
                if (waypoints.length > 2) {
                    const intermediateWaypoints = waypoints.slice(1, -1)
                        .map(wp => `${wp[0]},${wp[1]}`)
                        .join('|');
                    waypointsParam = `&waypoints=optimize:true|${intermediateWaypoints}`;
                }
                
                const googleUrl = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destination}${waypointsParam}&mode=driving&avoid=tolls&key=${apiKey}`;
                
                const response = await fetch(googleUrl);
                const data = await response.json();
                
                if (data.status === 'OK' && data.routes[0]) {
                    // Decode the polyline
                    const polyline = data.routes[0].overview_polyline.points;
                    return decodePolyline(polyline);
                }
                
                return null;
                
            } catch (error) {
                console.error('Google Directions API error:', error);
                return null;
            }
        }
        
        // Decode Google polyline algorithm
        function decodePolyline(encoded) {
            const poly = [];
            let index = 0, len = encoded.length;
            let lat = 0, lng = 0;
            
            while (index < len) {
                let b, shift = 0, result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                
                const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;
                
                shift = 0;
                result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                
                const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;
                
                poly.push([lat / 1E5, lng / 1E5]);
            }
            
            return poly;
        }
        
        // Calculate route distance from coordinates
        function calculateRouteDistance(route) {
            let totalDistance = 0;
            
            for (let i = 1; i < route.length; i++) {
                totalDistance += getDistanceBetweenPoints(
                    route[i - 1][0], route[i - 1][1],
                    route[i][0], route[i][1]
                );
            }
            
            return totalDistance;
        }
        
        // Haversine formula for distance calculation
        function getDistanceBetweenPoints(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Display optimization results
        function displayResults() {
            const routesList = document.getElementById('routesList');
            routesList.innerHTML = '';
            
            optimizationResults.forEach((route, index) => {
                const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                const routeItem = document.createElement('div');
                routeItem.className = 'route-item';
                routeItem.style.borderLeftColor = color;
                
                const stopsList = route.stops.map(stop => 
                    `Stop ${stop.cluster_number} (${stop.num_students} students)`
                ).join(', ');
                
                routeItem.innerHTML = `
                    <h5 style="color: ${color};">${route.busId}</h5>
                    <p><strong>Depot:</strong> ${route.depot}</p>
                    <p><strong>Total Students:</strong> ${route.totalStudents}/55 (${route.efficiency})</p>
                    <p><strong>Stops (${route.stops.length}):</strong> ${stopsList}</p>
                    <p><strong>Route Type:</strong> Major roads and highways prioritized</p>
                `;
                
                routesList.appendChild(routeItem);
            });
            
            document.getElementById('resultsPanel').style.display = 'block';
        }
        
        // Export results to CSV
        function exportResults() {
            if (!optimizationResults.length) {
                showStatus('No optimization results to export', 'error');
                return;
            }
            
            // Prepare export data
            const exportData = [];
            
            optimizationResults.forEach((route, routeIndex) => {
                route.stops.forEach((stop, stopIndex) => {
                    exportData.push({
                        bus_id: route.busId,
                        depot: route.depot,
                        route_sequence: stopIndex + 1,
                        stop_cluster: stop.cluster_number,
                        stop_lat: stop.snapped_lat,
                        stop_lon: stop.snapped_lon,
                        students_pickup: stop.num_students,
                        road_type: stop.route_type,
                        road_name: stop.route_name,
                        total_students_in_bus: route.totalStudents,
                        bus_efficiency: route.efficiency,
                        shift_time: document.getElementById('shiftTime').value,
                        day_of_week: document.getElementById('dayOfWeek').value
                    });
                });
            });
            
            // Convert to CSV
            const csv = Papa.unparse(exportData);
            
            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `optimized_routes_${document.getElementById('shiftTime').value}_${document.getElementById('dayOfWeek').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('Results exported successfully!', 'success');
        }
        
        // Advanced Google API integration (for real implementation)
        async function optimizeWithGoogleAPI() {
            const apiKey = GOOGLE_API_KEY;
            const projectId = 'YOUR_PROJECT_ID'; // Replace with actual project ID
            
            try {
                const requestData = prepareOptimizationRequest();
                
                const response = await fetch(`https://routeoptimization.googleapis.com/v1/projects/${projectId}:optimizeRoutes?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` // If using OAuth instead of API key
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Google API Error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                return processGoogleAPIResponse(result);
                
            } catch (error) {
                console.error('Google Route Optimization API Error:', error);
                
                // Fallback to simulation if API fails
                showStatus('API call failed, using simulation mode for demo', 'info');
                return await simulateOptimization();
            }
        }
        
        // Process Google API response
        function processGoogleAPIResponse(apiResponse) {
            const routes = [];
            
            if (apiResponse.routes) {
                apiResponse.routes.forEach((route, index) => {
                    const routeStops = [];
                    let totalStudents = 0;
                    
                    if (route.visits) {
                        route.visits.forEach(visit => {
                            if (visit.shipmentIndex !== undefined) {
                                const stop = stopsData[visit.shipmentIndex];
                                if (stop) {
                                    routeStops.push(stop);
                                    totalStudents += parseInt(stop.num_students);
                                }
                            }
                        });
                    }
                    
                    if (routeStops.length > 0) {
                        const maxCapacity = parseInt(document.getElementById('maxCapacity').value);
                        routes.push({
                            busId: `Bus ${index + 1}`,
                            depot: depotsData[index % depotsData.length]['Parking Name'],
                            stops: routeStops,
                            totalStudents: totalStudents,
                            efficiency: `${((totalStudents / maxCapacity) * 100).toFixed(1)}%`,
                            totalDistance: route.metrics?.totalDistance || 'N/A',
                            totalTime: route.metrics?.totalTime || 'N/A'
                        });
                    }
                });
            }
            
            return routes;
        }
        
        // Enhanced optimization with multiple algorithms
        async function enhancedOptimization() {
            const algorithms = [
                'nearest_neighbor',
                'savings_algorithm', 
                'sweep_algorithm',
                'cluster_first_route_second'
            ];
            
            const results = [];
            
            for (const algorithm of algorithms) {
                const result = await runOptimizationAlgorithm(algorithm);
                results.push({
                    algorithm: algorithm,
                    routes: result.routes,
                    totalDistance: result.totalDistance,
                    efficiency: result.efficiency
                });
            }
            
            // Return the best result based on efficiency and distance
            return results.sort((a, b) => {
                const scoreA = (a.efficiency * 0.6) + ((1 / a.totalDistance) * 0.4);
                const scoreB = (b.efficiency * 0.6) + ((1 / b.totalDistance) * 0.4);
                return scoreB - scoreA;
            })[0].routes;
        }
        
        // Placeholder for different optimization algorithms
        async function runOptimizationAlgorithm(algorithm) {
            // This would implement different VRP algorithms
            // For now, returning the simulation result
            const routes = await simulateOptimization();
            
            return {
                routes: routes,
                totalDistance: Math.random() * 1000 + 500, // Simulated
                efficiency: routes.reduce((acc, route) => acc + parseFloat(route.efficiency), 0) / routes.length
            };
        }
        
        // Real-time traffic integration (placeholder)
        async function getTrafficData(route) {
            // This would integrate with Google Maps Traffic API
            // or other traffic data providers
            return {
                currentTraffic: 'moderate',
                estimatedDelay: '5-10 minutes',
                alternativeRoutes: []
            };
        }
        
        // Route selection state
        let selectedRoute = null;
        
        // Initialize route selectors
        function initializeRouteSelectors() {
            const routeSelectorSection = document.getElementById('routeSelectorSection');
            const individualSelectors = document.getElementById('individualRouteSelectors');
            individualSelectors.innerHTML = '';
            selectedRoute = null;
            
            // Show the route selector section
            routeSelectorSection.style.display = 'block';
            
            // Add individual route radio buttons
            optimizationResults.forEach((route, index) => {
                const color = ROUTE_COLORS[index % ROUTE_COLORS.length];
                const routeId = `route-${index}`;
                
                const routeItem = document.createElement('label');
                routeItem.className = 'route-selector-item';
                
                const efficiency = ((route.totalStudents / 55) * 100).toFixed(1);
                const distance = route.actualDistance ? `${route.actualDistance.toFixed(1)} km` : '';
                const timeInfo = route.estimatedTime ? `~${route.estimatedTime} min` : '';
                
                routeItem.innerHTML = `
                    <input type="radio" name="routeSelection" id="${routeId}" onchange="selectRoute('${routeId}', ${index})">
                    <div style="flex: 1;">
                        <span style="color: ${color}; font-weight: 600;">${route.busId}</span>
                        <div style="margin-top: 4px; font-size: 12px; color: #718096;">
                            <span>${route.totalStudents} students</span>
                            <span style="margin: 0 8px;">•</span>
                            <span>${route.stops.length} stops</span>
                            ${distance ? `<span style="margin: 0 8px;">•</span><span>${distance}</span>` : ''}
                            ${timeInfo ? `<span style="margin: 0 8px;">•</span><span>${timeInfo}</span>` : ''}
                            <div style="margin-top: 2px;">Efficiency: ${efficiency}%</div>
                        </div>
                    </div>
                `;
                
                individualSelectors.appendChild(routeItem);
            });

            // Select "Show All" by default
            document.getElementById('selectAllRoutes').checked = true;
            document.querySelector('.route-selector-item').classList.add('selected');
            toggleAllRoutes();
        }
        
        // Toggle all routes
        function toggleAllRoutes() {
            if (document.getElementById('selectAllRoutes').checked) {
                selectedRoute = null;
                document.querySelectorAll('.route-selector-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelector('.route-selector-item').classList.add('selected');
                updateRouteVisibility();
            }
        }
        
        // Select individual route
        function selectRoute(routeId, index) {
            selectedRoute = routeId;
            
            // Update visual selection state
            document.querySelectorAll('.route-selector-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById(routeId).parentElement.classList.add('selected');
            
            updateRouteVisibility();
        }
        
        // Update route visibility on map
        function updateRouteVisibility() {
            // First, show/hide the route lines and their associated markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Polyline || (layer instanceof L.Marker && layer.options.className?.includes('route-'))) {
                    const routeClass = Array.from(layer.options.className?.split(' ') || [])
                        .find(cls => cls.startsWith('route-'));
                    
                    if (routeClass) {
                        const routeId = 'route-' + routeClass.split('-')[1];
                        const isVisible = selectedRoute === null || selectedRoute === routeId;
                        
                        if (isVisible) {
                            if (layer instanceof L.Polyline) {
                                layer.setStyle({ opacity: 0.8 });
                            } else {
                                layer.setOpacity(1);
                                layer.getElement()?.style.setProperty('opacity', '1');
                            }
                        } else {
                            if (layer instanceof L.Polyline) {
                                layer.setStyle({ opacity: 0 });
                            } else {
                                layer.setOpacity(0);
                                layer.getElement()?.style.setProperty('opacity', '0');
                            }
                        }
                    }
                }
            });

            // Update stop markers visibility
            if (optimizationResults) {
                const visibleStopIds = new Set();
                
                // Collect all stop IDs from selected route or all routes
                optimizationResults.forEach((route, index) => {
                    const routeId = `route-${index}`;
                    if (selectedRoute === null || selectedRoute === routeId) {
                        route.stops.forEach(stop => {
                            visibleStopIds.add(stop.cluster_number.toString());
                        });
                    }
                });

                // Update stop markers visibility
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker && !layer.options.className?.includes('route-')) {
                        const popupContent = layer.getPopup()?.getContent();
                        if (popupContent) {
                            // Extract stop number from popup content
                            const match = popupContent.match(/Stop (\d+)/);
                            if (match) {
                                const stopId = match[1];
                                if (visibleStopIds.has(stopId)) {
                                    layer.setOpacity(1);
                                    layer.getElement()?.style.setProperty('opacity', '1');
                                } else {
                                    layer.setOpacity(0);
                                    layer.getElement()?.style.setProperty('opacity', '0');
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Add event listeners for real-time validation
            document.getElementById('maxCapacity').addEventListener('change', function() {
                if (studentData.length > 0) {
                    updateMetrics();
                }
            });
            
            // API key is now hardcoded in the code
            
            showStatus('System initialized. Please load your CSV files to begin.', 'info');
        });
        
        // Error handling for API quotas and limits
        function handleAPIError(error) {
            if (error.message.includes('quota')) {
                showStatus('API quota exceeded. Please check your Google Cloud billing.', 'error');
            } else if (error.message.includes('authentication')) {
                showStatus('API authentication failed. Please check your API key.', 'error');
            } else {
                showStatus(`API Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>